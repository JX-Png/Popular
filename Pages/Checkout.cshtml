@page
@model PopularBookstore.Pages.CheckoutModel
@{
    ViewData["Title"] = "Checkout";
}

<partial name="_Header" />

<style>
    .checkout-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    .checkout-header {
        margin-bottom: 20px;
    }

    .order-summary {
        border: 2px solid #ffe0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: #fff9f9;
    }

    .order-item {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

        .order-item:last-child {
            border-bottom: none;
        }

    .item-image {
        width: 60px;
        height: 80px;
        margin-right: 15px;
    }

        .item-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

    .item-details {
        flex-grow: 1;
    }

    .item-title {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .item-author {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 5px;
    }

    .item-price {
        text-align: right;
        min-width: 80px;
    }

    .order-total {
        text-align: right;
        font-size: 1.2em;
        font-weight: bold;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 2px solid #eee;
    }

    .checkout-actions {
        margin-top: 30px;
        text-align: right;
    }

    .btn-checkout {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 12px 30px;
        font-size: 1.1em;
        border-radius: 4px;
        cursor: pointer;
    }

        .btn-checkout:hover {
            background-color: #45a049;
        }

    .order-confirmation {
        text-align: center;
        padding: 30px;
        background-color: #f8fff8;
        border-radius: 8px;
        border: 2px solid #4CAF50;
    }

    .confirmation-icon {
        font-size: 48px;
        color: #4CAF50;
        margin-bottom: 20px;
    }

    .back-link {
        display: inline-block;
        margin-top: 20px;
    }

    /* Payment method styling */
    .payment-method {
        border: 2px solid #ffe0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: #fff9f9;
    }

    .payment-cards-selection {
        margin-top: 15px;
    }

    .payment-card-option {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
    }

        .payment-card-option input[type="radio"] {
            margin-right: 15px;
        }

        .payment-card-option label {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            margin-bottom: 0;
            cursor: pointer;
        }

        .payment-card-option .card-name {
            font-weight: bold;
        }

        .payment-card-option .card-number,
        .payment-card-option .card-expiry {
            color: #666;
            font-size: 0.9em;
        }

    .add-new-card {
        margin-top: 15px;
    }

    .default-badge {
        background-color: #28a745;
        color: white;
        font-size: 0.8em;
        padding: 2px 6px;
        border-radius: 10px;
        display: inline-block;
        margin-left: 5px;
    }

    /* Shipping information styling */
    .shipping-info {
        border: 2px solid #ffe0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: #fff9f9;
    }

    .form-group {
        margin-bottom: 15px;
    }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }

    .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .validation-message {
        color: #dc3545;
        font-size: 0.9em;
    }

    .checkout-section-title {
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
    }
</style>

<div class="checkout-container">
    @if (Model.OrderCompleted)
    {
        <div class="order-confirmation">
            <div class="confirmation-icon">✓</div>
            <h2>Thank you for your order!</h2>
            <p>Your order #@Model.OrderId has been placed successfully.</p>
            <p>We'll process your order as soon as possible.</p>
            <a asp-page="/OrderHistory" class="back-link">View your orders</a>
        </div>
    }
    else
    {
        <div class="checkout-header">
            <h2>Checkout</h2>
            <p>Please review your order and complete the checkout process.</p>
        </div>

        <form method="post">
            <div class="order-summary">
                <h3 class="checkout-section-title">Order Summary</h3>
                @foreach (var item in Model.CartItems)
                {
                    <div class="order-item">
                        <div class="item-image">
                            @if (item.ImageData != null && item.ImageMimeType != null)
                            {
                                <img src="data:@item.ImageMimeType;base64,@Convert.ToBase64String(item.ImageData)" alt="@item.Title" />
                            }
                            else if (!string.IsNullOrEmpty(item.ImageUrl))
                            {
                                <img src="@item.ImageUrl" alt="@item.Title" />
                            }
                        </div>
                        <div class="item-details">
                            <div class="item-title">@item.Title</div>
                            <div class="item-author">by @item.Author</div>
                            <div>Qty: @item.Quantity</div>
                        </div>
                        <div class="item-price">
                            @((item.Price * item.Quantity).ToString("C"))
                        </div>
                    </div>
                }

                <div class="order-total">
                    Total: @Model.TotalAmount.ToString("C")
                </div>
            </div>

            <div class="shipping-info">
                <h3 class="checkout-section-title">Shipping Information</h3>
                <div class="form-group">
                    <label asp-for="ShippingAddress.FullName"></label>
                    <input asp-for="ShippingAddress.FullName" class="form-control" />
                    <span asp-validation-for="ShippingAddress.FullName" class="validation-message"></span>
                </div>
                <div class="form-group">
                    <label asp-for="ShippingAddress.Address"></label>
                    <input asp-for="ShippingAddress.Address" class="form-control" />
                    <span asp-validation-for="ShippingAddress.Address" class="validation-message"></span>
                </div>
                <div class="form-group">
                    <label asp-for="ShippingAddress.City"></label>
                    <input asp-for="ShippingAddress.City" class="form-control" />
                    <span asp-validation-for="ShippingAddress.City" class="validation-message"></span>
                </div>
                <div class="form-group">
                    <label asp-for="ShippingAddress.PostalCode"></label>
                    <input asp-for="ShippingAddress.PostalCode" class="form-control" />
                    <span asp-validation-for="ShippingAddress.PostalCode" class="validation-message"></span>
                </div>
                <div class="form-group">
                    <label asp-for="ShippingAddress.Country"></label>
                    <input asp-for="ShippingAddress.Country" class="form-control" />
                    <span asp-validation-for="ShippingAddress.Country" class="validation-message"></span>
                </div>
            </div>

            <div class="payment-method">
                <h3 class="checkout-section-title">Payment Method</h3>

                @if (!Model.PaymentCards.Any())
                {
                    <div class="alert alert-warning">
                        You don't have any payment methods saved.
                        <a asp-page="/Settings">Add a payment method</a> before continuing with checkout.
                    </div>
                }
                else
                {
                    <div class="payment-cards-selection">
                        @foreach (var card in Model.PaymentCards)
                        {
                            <div class="payment-card-option">
                                <input type="radio" asp-for="SelectedPaymentCardId" id="card-@card.Id" value="@card.Id" />
                                <label for="card-@card.Id">
                                    <span class="card-name">
                                        @card.CardName
                                        @if (card.IsDefault)
                                        {
                                            <span class="default-badge">Default</span>
                                        }
                                    </span>
                                    <span class="card-number">@card.GetMaskedCardNumber()</span>
                                    <span class="card-expiry">Expires: @card.ExpiryMonth/@card.ExpiryYear</span>
                                </label>
                            </div>
                        }
                    </div>
                    <div class="add-new-card">
                        <a asp-page="/Settings" class="btn btn-outline-secondary btn-sm">Manage Payment Methods</a>
                    </div>
                    <span asp-validation-for="SelectedPaymentCardId" class="validation-message"></span>
                }
            </div>

            <div class="checkout-actions">
                <button type="submit" class="btn-checkout" @(Model.PaymentCards.Any() ? "" : "disabled")>
                    Complete Purchase
                </button>
            </div>
        </form>
    }
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}